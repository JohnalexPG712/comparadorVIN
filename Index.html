<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Comparador de VINs: Documentos Soporte vs FMM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configuración esencial para el worker de PDF.js para que funcione en la mayoría de navegadores
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;
    </script>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7fafd; margin: 0; }
        .container { max-width: 1100px; margin: 36px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); padding: 32px; border: 1px solid #d7e1ec; }
        h2 { color: #2661a9; margin-top: 0; border-bottom: 2px solid #2661a9; padding-bottom: 5px; margin-bottom: 20px; }
        p { line-height: 1.5; margin-bottom: 15px; color: #333; }
        label { font-weight: bold; display: block; margin-bottom: 8px; }
        .form-group { margin-bottom: 28px; }
        input[type="file"] { display: block; margin-top: 4px; }
        .file-input-label { color: #555; font-size: 0.9em; margin-top: 5px; display: block; }
        button { background: #2661a9; color: #fff; border: none; border-radius: 4px; padding: 10px 22px; font-size: 1rem; cursor: pointer; margin-right: 10px; transition: background 0.2s ease; }
        button:hover { background: #1a4171; }
        button:active { background: #1a4171; }
        .clear-btn { background: #e74c3c; }
        .clear-btn:hover { background: #c0392b; }
        .download-btn { background: #27ae60; }
        .download-btn:hover { background: #229954; }
        h3 { margin-top: 32px; color: #333; border-top: 1px solid #c9d6e2; padding-top: 20px; }
        .result-area { background: #f4f8fb; border: 1px solid #c9d6e2; border-radius: 5px; min-height: 60px; padding: 18px; margin-top: 10px; font-size: 0.95rem; color: #555; word-wrap: break-word; }
        .found-small { color: #27ae60; }
        .notfound { color: #e74c3c; font-weight: bold; }
        .vin { font-family: 'Courier New', Courier, monospace; background-color: #e9ecef; padding: 2px 4px; border-radius: 3px; }
        .coincidencias-total { color: #2661a9; font-weight: bold; }
        .invalid-vin { color: #f39c12; }
        hr { border: none; border-top: 1px solid #c9d6e2; margin: 25px 0; }
        @media (max-width: 600px) { .container { padding: 15px; } h2 { font-size: 1.2em; } }
    </style>
</head>
<body>
    <div class="container">
        <h2>Comparador de VINs: Documentos Soporte vs FMM</h2>
        <p>Permite comparar y verificar los VIN entre el Formato de Movimiento de Mercancías (FMM) y los documentos soporte de las transacciones 329, 401, 422 y 436 (DI, DUTA, Factura o Remisión), detectando coincidencias incluso si los VIN están partidos por espacios o saltos de línea.</p>
        <div class="form-group">
            <label for="pdfFiles">1. Selecciona los Archivo(s) PDF de Soporte:</label>
            <input type="file" id="pdfFiles" accept=".pdf" multiple>
            <div id="pdfFilesLabel" class="file-input-label">Ningún archivo seleccionado</div>
        </div>
        <div class="form-group">
            <label for="excelFile">2. Selecciona el Archivo Excel (FMM):</label>
            <input type="file" id="excelFile" accept=".xlsx,.xls">
            <div id="excelFileLabel" class="file-input-label">Ningún archivo seleccionado</div>
        </div>
        <button onclick="buscarDatos()">3. Procesar y Comparar</button>
        <button class="clear-btn" onclick="borrarSeleccion()">Borrar Selección y Resultados</button>
        <button class="download-btn" id="downloadBtn" style="display:none;" onclick="descargarExcel()">Descargar Resultados en Excel</button>
        <h3>Resultados de la Comparación:</h3>
        <div class="result-area" id="resultados">Selecciona los archivos y haz clic en 'Procesar y Comparar' para ver los resultados.</div>
    </div>
    <script>
        let resultadosParaExcel = [];

        document.getElementById('pdfFiles').addEventListener('change', function() {
            const fileCount = this.files.length;
            document.getElementById('pdfFilesLabel').textContent = fileCount > 0 ? `${fileCount} archivo(s) PDF seleccionado(s)` : 'Ningún archivo seleccionado';
        });
        document.getElementById('excelFile').addEventListener('change', function() {
            document.getElementById('excelFileLabel').textContent = this.files[0]?.name || 'Ningún archivo seleccionado';
        });

        function borrarSeleccion() {
            document.getElementById('pdfFiles').value = '';
            document.getElementById('excelFile').value = '';
            document.getElementById('pdfFilesLabel').textContent = 'Ningún archivo seleccionado';
            document.getElementById('excelFileLabel').textContent = 'Ningún archivo seleccionado';
            document.getElementById('resultados').innerHTML = "Selecciona los archivos y haz clic en 'Procesar y Comparar' para ver los resultados.";
            document.getElementById('downloadBtn').style.display = 'none';
            resultadosParaExcel = [];
        }

        function normalizarVIN(vin) {
            return (vin ? String(vin) : '').replace(/[\s\r\n\t]+/g, '').toUpperCase();
        }

        function validarVIN(vin) {
            const vinLimpio = normalizarVIN(vin);
            return /^[A-HJ-NPR-Z0-9]{17}$/.test(vinLimpio);
        }

        function esVinPlausible(vin) {
            if (vin.length !== 17) return false;
            if (/[A-Z]{6,}/.test(vin)) return false;
            const wmi = vin.substring(0, 3);
            if ((wmi.match(/[A-Z]/g) || []).length < 2) return false;
            const serial = vin.substring(11);
            if ((serial.match(/[0-9]/g) || []).length < 4) return false;
            return true;
        }

        async function leerExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet, { header: 1, blankrows: false, defval: "" });
                        if (json.length === 0) { resolve([]); return; }
                        let dataRows = json;
                        const primerPosibleVin = normalizarVIN(json[0][1]);
                        if (!validarVIN(primerPosibleVin)) {
                            dataRows = json.slice(1);
                        }
                        const vins = dataRows.map(row => normalizarVIN(row[1])).filter(Boolean);
                        resolve(vins);
                    } catch (error) { reject(error); }
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function leerPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let textoCompleto = '';
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                const pageText = content.items.map(item => item.str).join(' ');
                textoCompleto += pageText.replace(/\s+/g, ' ') + ' ';
            }
            return textoCompleto.toUpperCase();
        }

        function buscarVinFlexible(vin, textoPDF) {
            const escapedVin = vin.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            const vinRegex = new RegExp(escapedVin.split('').join('\\s*'), 'i');
            return vinRegex.test(textoPDF);
        }

        async function buscarDatos() {
            const excelInput = document.getElementById('excelFile');
            const pdfInput = document.getElementById('pdfFiles');
            const resultadosDiv = document.getElementById('resultados');
            resultadosDiv.innerHTML = 'Procesando archivos... Esto puede tardar unos segundos.';
            document.getElementById('downloadBtn').style.display = 'none';
            resultadosParaExcel = [];

            if (!excelInput.files[0] || pdfInput.files.length === 0) {
                resultadosDiv.innerHTML = '<span class="notfound">Error: Debes seleccionar un archivo Excel y al menos un archivo PDF.</span>';
                return;
            }

            try {
                const todosLosVinsDelExcel = await leerExcel(excelInput.files[0]);
                
                let vinValidosExcel = [];
                let vinInvalidosExcel = [];
                todosLosVinsDelExcel.forEach(vin => {
                    if (validarVIN(vin)) {
                        vinValidosExcel.push(vin);
                    } else if (vin) {
                        vinInvalidosExcel.push({ vin: vin, length: vin.length });
                    }
                });

                const pdfFiles = Array.from(pdfInput.files);
                let textosPDF = {};
                let textoConcatenadoPDF = '';
                for (const pdfFile of pdfFiles) {
                    const texto = await leerPDF(pdfFile);
                    textosPDF[pdfFile.name] = texto;
                    textoConcatenadoPDF += texto;
                }

                // --- INICIO DE LA LÓGICA DE ANÁLISIS ---
                const vinExcelCount = {};
                vinValidosExcel.forEach(vin => {
                    vinExcelCount[vin] = (vinExcelCount[vin] || 0) + 1;
                });
                const vinUnicosExcel = new Set(Object.keys(vinExcelCount));
                const vinRepetidosExcel = Object.keys(vinExcelCount).filter(vin => vinExcelCount[vin] > 1);

                const vinEncontradosEnPDF = new Map();
                vinUnicosExcel.forEach(vin => {
                    const archivosDondeAparece = [];
                    for (const [nombreArchivo, texto] of Object.entries(textosPDF)) {
                        if (buscarVinFlexible(vin, texto)) {
                            archivosDondeAparece.push(nombreArchivo);
                        }
                    }
                    if (archivosDondeAparece.length > 0) {
                        vinEncontradosEnPDF.set(vin, archivosDondeAparece);
                    }
                });

                const vinSoloEnExcel = new Set([...vinUnicosExcel].filter(vin => !vinEncontradosEnPDF.has(vin)));
                
                const textoPdfSinEspacios = textoConcatenadoPDF.replace(/\s/g, '');
                
                // *** CAMBIO CLAVE: Usar regex con lookarounds para evitar "VINs Frankenstein" ***
                const vinRegex = /(?<![A-HJ-NPR-Z0-9])[A-HJ-NPR-Z0-9]{17}(?![A-HJ-NPR-Z0-9])/g;

                const posiblesVinsEnPDF = textoPdfSinEspacios.match(vinRegex) || [];
                const vinSoloEnPDF = new Set([...new Set(posiblesVinsEnPDF)].filter(vin => 
                    !vinUnicosExcel.has(vin) && esVinPlausible(vin)
                ));
                // --- FIN DE LA LÓGICA DE ANÁLISIS ---

                // --- CONSTRUCCIÓN DEL REPORTE HTML ---
                let invalidosHTML = '';
                if (vinInvalidosExcel.length > 0) {
                    invalidosHTML = '<b>VINs con formato inválido encontrados en Excel:</b><br>';
                    vinInvalidosExcel.forEach(item => {
                        invalidosHTML += `<span class="invalid-vin">VIN <span class="vin">${item.vin}</span> (longitud: ${item.length}) no cumple el estándar.</span><br>`;
                    });
                }
                
                let resumenHTML = `
                    <div style="line-height: 1.6; margin-bottom: 15px;">
                        Total de VINs en Excel: <b>${vinUnicosExcel.size}</b><br>
                        Total de VINs encontrados en al menos un PDF: <b>${vinEncontradosEnPDF.size}</b><br>
                        <b class="coincidencias-total">Total de coincidencias encontradas: ${vinEncontradosEnPDF.size}</b><br>
                        <b class="notfound">VINs repetidos en el Excel: ${vinRepetidosExcel.length}</b><br>
                        Número de VINs encontrados Únicamente en los (PDF): <b>${vinSoloEnPDF.size}</b><br>
                        Número de VINs encontrados Únicamente en el FMM (Excel): <b>${vinSoloEnExcel.size}</b><br>
                        ${invalidosHTML ? `<br>${invalidosHTML}` : ''}
                        <br>
                        VINs encontrados únicamente en la(s) DI (PDF):<br>
                        <div style="font-family: 'Courier New', Courier, monospace; padding-left: 15px; word-break: break-all;">${vinSoloEnPDF.size > 0 ? [...vinSoloEnPDF].join(', ') : 'Ninguno'}</div>
                        <br>
                        VINs repetidos en el Excel:<br>
                        <div style="font-family: 'Courier New', Courier, monospace; padding-left: 15px; word-break: break-all;">${vinRepetidosExcel.length > 0 ? vinRepetidosExcel.join(', ') : 'Ninguno'}</div>
                    </div>`;
                
                let resultadosDetalladosHTML = ''; 
                const vinsOriginalesUnicos = [...new Set(vinValidosExcel)];

                for (const vin of vinsOriginalesUnicos.sort()) {
                     const coincidencias = vinEncontradosEnPDF.get(vin);
                     if (coincidencias) {
                         resultadosDetalladosHTML += `<div class="found-small">VIN ${vin} encontrado en: <b>${coincidencias.join(', ')}</b></div>`;
                     } else {
                         resultadosDetalladosHTML += `<div class="notfound">VIN ${vin} NO ENCONTRADO en ningún PDF.</div>`;
                     }
                }
                
                resultadosParaExcel = [];
                [...vinUnicosExcel].sort().forEach(vin => {
                    const encontradoEn = vinEncontradosEnPDF.get(vin);
                    resultadosParaExcel.push({
                        "VIN": vin,
                        "Estado": encontradoEn ? "Encontrado" : "No Encontrado en PDF",
                        "Archivos PDF": encontradoEn ? encontradoEn.join(', ') : "N/A",
                        "Repetido en Excel": vinRepetidosExcel.includes(vin) ? "Sí" : "No"
                    });
                });
                 [...vinSoloEnPDF].sort().forEach(vin => {
                    resultadosParaExcel.push({
                        "VIN": vin,
                        "Estado": "Solo en PDF",
                        "Archivos PDF": "N/A",
                        "Repetido en Excel": "N/A"
                    });
                });

                resultadosDiv.innerHTML = resumenHTML + '<hr>' + resultadosDetalladosHTML;
                
                if (resultadosParaExcel.length > 0) {
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                }

            } catch (error) {
                console.error("Ocurrió un error durante el procesamiento:", error);
                resultadosDiv.innerHTML = `<span class="notfound">Error al procesar los archivos. Revisa la consola para más detalles. Asegúrate de que los archivos no estén corruptos.</span>`;
            }
        }

        function descargarExcel() {
            if (resultadosParaExcel.length === 0) {
                alert("No hay resultados para descargar.");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(resultadosParaExcel);
            ws['!cols'] = [{ wch: 20 }, { wch: 25 }, { wch: 50 }, { wch: 20 }];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Resultados Comparacion VIN");
            XLSX.writeFile(wb, "Reporte_Comparacion_VIN.xlsx");
        }
    </script>
</body>
</html>